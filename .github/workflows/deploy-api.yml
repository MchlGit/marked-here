name: Deploy API (App Runner) 

on: 
  push:
    branches: ["main"]
    paths:
      - "server-dotnet/**"
      - ".github/workflows/deploy-api.yml"

permissions: 
  id-token: write
  contents: read

jobs: 
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      ECR_REPO: marked-here-api
    steps: 
      - uses: actions/checkout@v4

      - name: Debug GitHub context
        run: |
          echo "REPO=$GITHUB_REPOSITORY"
          echo "REF=$GITHUB_REF"
          echo "arn:aws:iam::${{vars.AWS_ACCOUNT_ID}}:role/GitHubActionsDeployRole"
      
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{vars.AWS_ACCOUNT_ID}}:role/GitHubActionsDeployRole
          aws-region: ${{env.AWS_REGION}}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image 
        working-directory: server-dotnet
        run: | 
          IMAGE_URI="${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest"
          docker build -t "$IMAGE_URI" . 
          docker push "$IMAGE_URI"
